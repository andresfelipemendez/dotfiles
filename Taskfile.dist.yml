version: '3'

vars:
    REPO_PATH: '{{.REPO_PATH | default "/Users/andres/Developer/hiro-gdk"}}'
    TARGET_PATH: '{{.TARGET_PATH | default "../ProjectTemplate/lib"}}'
    
tasks:
    # Git utilities
    gu:
        desc: 'Git update - fetch and pull latest changes'
        dir: '{{.USER_WORKING_DIR}}'
        cmds:
            - git fetch
            - git pull
        preconditions:
            - sh: docker info > /dev/null 2>&1
              msg: 'Docker is not running'
            - sh: git rev-parse --git-dir
              msg: 'Not a git repository'

    # New worktree workflow
    nwt:
        desc: 'Create new worktree, build Hiro, generate license, and start docker compose'
        summary: |
            Creates a new git worktree from main branch, builds the Hiro plugin,
            copies it to ProjectTemplate/lib, generates a Hiro license, and starts docker compose.
            Usage: task nwt BRANCH=feature-name (am- prefix will be added automatically to branch)
            Note: Folder name uses the provided name, branch gets am- prefix
        vars:
            FOLDER_NAME:
                sh: echo "{{.BRANCH}}" | sed 's/^am-//'
            BRANCH_NAME:
                sh: |
                    if echo "{{.BRANCH}}" | grep -q '^am-'; then
                        echo "{{.BRANCH}}"
                    else
                        echo "am-{{.BRANCH}}"
                    fi
        cmds:
            - cd {{.REPO_PATH}}/main && git fetch && git pull
            - cd {{.REPO_PATH}}/main && git worktree add ../{{.FOLDER_NAME}} -b {{.BRANCH_NAME}} main
            - cd {{.REPO_PATH}}/{{.FOLDER_NAME}}/server && docker run --platform "linux/arm64" --rm -w "/server" -v "$(pwd):/server" heroiclabs/nakama-pluginbuilder:{{.PLUGIN_BUILDER_VSN}} build --buildmode=plugin -trimpath -o "./hiro-linux-arm64.bin"
            - mkdir -p {{.REPO_PATH}}/{{.FOLDER_NAME}}/ProjectTemplate/lib
            - cp {{.REPO_PATH}}/{{.FOLDER_NAME}}/server/hiro-linux-arm64.bin {{.REPO_PATH}}/{{.FOLDER_NAME}}/ProjectTemplate/lib/
            - task: project-template-license
              vars:
                FOLDER_NAME: '{{.FOLDER_NAME}}'
            - docker rm -f game_backend_nakama game_backend_postgres 2>/dev/null || true
            - cd {{.REPO_PATH}}/{{.FOLDER_NAME}} && exec $SHELL
        requires:
            vars: [BRANCH]
        preconditions:
            - sh: '[ -d "{{.REPO_PATH}}/main" ]'
              msg: 'Repository main branch not found at {{.REPO_PATH}}/main'
            - sh: command -v docker
              msg: 'Docker is not installed'

    # Checkout existing remote branch as worktree
    ewt:
        desc: 'Checkout existing remote branch as worktree, build Hiro, and generate license'
        summary: |
            Fetches latest from remote, creates a worktree for an existing remote branch,
            builds the Hiro plugin, copies it to ProjectTemplate/lib, and generates a Hiro license.
            Usage: task ewt BRANCH=am-feature-name
            Note: Branch keeps initials prefix, but folder name strips it
        vars:
            FOLDER_NAME:
                sh: echo "{{.BRANCH}}" | sed 's/^am-//'
        cmds:
            - cd {{.REPO_PATH}}/main && git fetch
            - cd {{.REPO_PATH}}/main && git worktree add ../{{.FOLDER_NAME}} {{.BRANCH}}
            - cd {{.REPO_PATH}}/{{.FOLDER_NAME}}/server && docker run --platform "linux/arm64" --rm -w "/server" -v "$(pwd):/server" heroiclabs/nakama-pluginbuilder:{{.PLUGIN_BUILDER_VSN}} build --buildmode=plugin -trimpath -o "./hiro-linux-arm64.bin"
            - mkdir -p {{.REPO_PATH}}/{{.FOLDER_NAME}}/ProjectTemplate/lib
            - cp {{.REPO_PATH}}/{{.FOLDER_NAME}}/server/hiro-linux-arm64.bin {{.REPO_PATH}}/{{.FOLDER_NAME}}/ProjectTemplate/lib/
            - task: project-template-license
              vars:
                FOLDER_NAME: '{{.FOLDER_NAME}}'
            - docker rm -f game_backend_nakama game_backend_postgres 2>/dev/null || true
            - cd {{.REPO_PATH}}/{{.FOLDER_NAME}} && exec $SHELL
        requires:
            vars: [BRANCH]
        preconditions:
            - sh: '[ -d "{{.REPO_PATH}}/main" ]'
              msg: 'Repository main branch not found at {{.REPO_PATH}}/main'
            - sh: command -v docker
              msg: 'Docker is not installed'

    # Tmux session opener
    t:
        desc: 'Open new tmux session in ~/Developer but keep current directory context'
        cmds:
            - tmux new-session "cd '{{.USER_WORKING_DIR}}' && exec $SHELL"
        preconditions:
            - sh: command -v tmux
              msg: 'tmux is not installed'

    # Docker cleanup
    docker-nuke:
        desc: 'Stop all containers and prune Docker system (removes everything)'
        prompt: 'This will stop all containers and remove all Docker data. Continue?'
        cmds:
            - docker stop $(docker ps -aq) 2>/dev/null || true
            - docker system prune -a --volumes -f

    # Hiro worktree management helpers
    list-worktrees:
        desc: 'List all git worktrees in the Hiro repository'
        dir: '{{.REPO_PATH}}/main'
        cmds:
            - git worktree list

    remove-worktree:
        desc: 'Remove a git worktree'
        summary: |
            Removes a git worktree and its associated branch.
            Usage: task remove-worktree BRANCH=am-feature-name
            Note: Provide the full branch name with am- prefix
        vars:
            FOLDER_NAME:
                sh: echo "{{.BRANCH}}" | sed 's/^am-//'
        dir: '{{.REPO_PATH}}/main'
        cmds:
            - git worktree remove ../{{.FOLDER_NAME}}
            - git branch -D {{.BRANCH}}
        requires:
            vars: [BRANCH]
        preconditions:
            - sh: '[ -d "{{.REPO_PATH}}/{{.FOLDER_NAME}}" ]'
              msg: 'Worktree {{.FOLDER_NAME}} does not exist'

    # Quick navigation helpers
    goto-hiro:
        desc: 'Change to Hiro main directory'
        cmds:
            - cd {{.REPO_PATH}}/main && exec $SHELL

    goto-worktree:
        desc: 'Change to a specific Hiro worktree'
        summary: |
            Navigate to a specific worktree directory.
            Usage: task goto-worktree BRANCH=am-feature-name
            Note: Provide the full branch name with am- prefix
        vars:
            FOLDER_NAME:
                sh: echo "{{.BRANCH}}" | sed 's/^am-//'
        cmds:
            - cd {{.REPO_PATH}}/{{.FOLDER_NAME}} && exec $SHELL
        requires:
            vars: [BRANCH]
        preconditions:
            - sh: '[ -d "{{.REPO_PATH}}/{{.FOLDER_NAME}}" ]'
              msg: 'Worktree {{.FOLDER_NAME}} does not exist'

    # Media conversion
    video-to-mp3:
        desc: 'Convert video file to mp3 audio'
        summary: |
            Converts a video file to mp3 audio format using ffmpeg.
            Audio is converted to mono, 16kHz sample rate, 64k bitrate.
            Usage: task video-to-mp3 -- video-file.mov
            Output will have the same name but with .mp3 extension
        vars:
            INPUT_FILE: '{{.USER_WORKING_DIR}}/{{.CLI_ARGS}}'
            OUTPUT:
                sh: echo "{{.USER_WORKING_DIR}}/{{.CLI_ARGS}}" | sed 's/\.[^.]*$/.mp3/'
        cmds:
            - ffmpeg -i "{{.INPUT_FILE}}" -vn -ac 1 -ar 16000 -ab 64k -f mp3 "{{.OUTPUT}}"
            - echo "Converted {{.CLI_ARGS}} to {{.OUTPUT}}"
        preconditions:
            - sh: command -v ffmpeg
              msg: 'ffmpeg is not installed'
            - sh: '[ -f "{{.USER_WORKING_DIR}}/{{.CLI_ARGS}}" ]'
              msg: 'File {{.CLI_ARGS}} does not exist in current directory'
